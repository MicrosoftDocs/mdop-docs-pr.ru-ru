---
title: Включение BitLocker с помощью MBAM в составе развертывания Windows
description: Включение BitLocker с помощью MBAM в составе развертывания Windows
author: dansimp
ms.assetid: 7609ad7a-bb06-47be-b186-0a2db787c8a5
ms.reviewer: ''
manager: dansimp
ms.author: dansimp
ms.pagetype: mdop, security
ms.mktglfcycl: manage
ms.sitesec: library
ms.prod: w10
ms.date: 04/23/2017
ms.openlocfilehash: 4b2cbf333c705088d0a068521fb65e99551bb1f1
ms.sourcegitcommit: 354664bc527d93f80687cd2eba70d1eea024c7c3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/26/2020
ms.locfileid: "10826229"
---
# Включение BitLocker с помощью MBAM в составе развертывания Windows


В этой статье объясняется, как включить BitLocker на компьютере конечного пользователя с помощью MBAM в рамках процесса создания образов и развертывания Windows. Если при перезагрузке появляется черный экран (после завершения установки), указывающий на то, что диск не может быть разблокирован, другие [версии Windows не запускаются после этапа "Настройка Windows и Configuration Manager", если вы используете предварительную версию BitLocker в Windows 10 версии 1511](https://support.microsoft.com/en-us/help/4494799/earlier-windows-versions-don-t-start-after-you-use-pre-provision-bitlo).

**Необходимые условия**

-   Должен быть установлен существующий процесс развертывания образа Windows (MDT), Microsoft System Center Configuration Manager или некоторые другие инструменты или процессы обработки изображений.

-   Доверенный платформенный модуль должен быть включен в BIOS и отображаться для операционной системы

-   Инфраструктура сервера MBAM должна быть на своем сервере и доступна для людей с ограниченными возможностями

-   Необходимо создать системный раздел, необходимый для BitLocker

-   Во время обработки изображений компьютер должен быть присоединен к домену, прежде чем MBAM полностью включит BitLocker.

**Включение BitLocker с помощью MBAM 2,5 SP1 в рамках развертывания Windows**

1. В MBAM 2,5 с пакетом обновления 1 (SP1) рекомендованный подход к включению BitLocker во время развертывания Windows — это использование `Invoke-MbamClientDeployment.ps1` сценария PowerShell.

   -   Сценарий задействует `Invoke-MbamClientDeployment.ps1` BitLocker во время процесса обработки изображений. При использовании политики BitLocker агент MBAM немедленно предлагает пользователю домена создать PIN-код или пароль, когда пользователь домена впервые входит в систему после завершения работы с программой Imaging.

   -   Простота использования с помощью MDT, System Center Configuration Manager и автономных процессов обработки изображений

   -   Совместимость с PowerShell 2,0 или более новой версией

   -   Шифрование тома ОС с предохранителем ключа TPM

   -   Полная поддержка предварительной подготовки BitLocker

   -   При необходимости зашифруйте FDDs

   -   OwnerAuthных доверенных платформенных модулях (TPM) для Windows 7 MBAM должен быть владельцем TPM.
   Для Windows 8,1, Windows 10 RTM и Windows 10 версии 1511 OwnerAuth доверенного платформенного модуля поддерживается.
   В Windows 10 версии 1607 или более поздней права собственности на этот доверенный платформенный модуль могут получить только Windows. В addiiton при подготовке доверенного платформенного модуля Windows не сохранит пароль владельца доверенного платформенного модуля. Дополнительные сведения приведены в разделе [пароль владельца доверенного платформенного модуля](https://docs.microsoft.com/windows/security/hardware-protection/tpm/change-the-tpm-owner-password) .

   -   Резервные ключи и пакеты ключей восстановления

   -   Немедленное создание отчета о состоянии шифрования

   -   Новые поставщики WMI

   -   Подробный журнал

   -   Надежная обработка ошибок

   Вы можете скачать `Invoke-MbamClientDeployment.ps1` сценарий из [центра загрузки Microsoft.com](https://www.microsoft.com/download/details.aspx?id=54439). Это основной сценарий, который ваша система развертывания будет вызывать для настройки шифрования диска BitLocker и записи ключей восстановления с сервера MBAM.

   **Способы развертывания WMI для MBAM:** Следующие методы WMI были добавлены в MBAM 2,5 с пакетом обновления 1 (SP1) для поддержки включения BitLocker с помощью `Invoke-MbamClientDeployment.ps1` сценария PowerShell.

   <a href="" id="mbam-machine-wmi-class"></a>Класс WMI MBAM **\ _Machine** 
    **PrepareTpmAndEscrowOwnerAuth:** Чтение доверенного платформенного модуля OwnerAuth и его отправка в базу данных восстановления MBAM с помощью службы восстановления MBAM. Если доверенный платформенный модуль не является владельцем, а автоматическая подготовка не включена, она создает доверенный платформенный модуль OwnerAuth и принимает владение. В случае сбоя возвращается код ошибки для устранения неполадок.

   **Примечание** В Windows 10 версии 1607 или более поздней права собственности на этот доверенный платформенный модуль могут получить только Windows. В addiiton при подготовке доверенного платформенного модуля Windows не сохранит пароль владельца доверенного платформенного модуля. Дополнительные сведения приведены в разделе [пароль владельца доверенного платформенного модуля](https://docs.microsoft.com/windows/security/hardware-protection/tpm/change-the-tpm-owner-password) .

| Параметр | Описание |
| -------- | ----------- |
| RecoveryServiceEndPoint | Строка, указывающая конечную точку службы восстановления MBAM. |

Ниже перечислены распространенные сообщения об ошибках.

| Общие возвращаемые значения | Сообщение об ошибке |
| -------------------- | ------------- |
|  **S_OK**<br />0 (0x0) | Метод успешно выполнен. |
| **MBAM_E_TPM_NOT_PRESENT**<br />2147746304 (0x80040200) | Доверенный платформенный модуль отсутствует на компьютере или отключен в конфигурации BIOS. |
| **MBAM_E_TPM_INCORRECT_STATE**<br />2147746305 (0x80040201) | Доверенный платформенный модуль не находится в правильном состоянии (разрешено, активировано и установлен владелец). |
| **MBAM_E_TPM_AUTO_PROVISIONING_PENDING**<br />2147746306 (0x80040202) | MBAM не может сменить владельца доверенного платформенного модуля, так как ожидается автоматическое наполнение. Повторите попытку после завершения автоматической подготовки. |
| **MBAM_E_TPM_OWNERAUTH_READFAIL**<br />2147746307 (0x80040203) | MBAM не может прочитать значение авторизации владельца доверенного платформенного модуля. Это значение может быть удалено после успешного депонирования. В Windows 7 MBAM не может считать значение, если TPM владеет другими пользователями. |
| **MBAM_E_REBOOT_REQUIRED**<br />2147746308 (0x80040204) | Чтобы настроить доверенный платформенный модуль на правильное состояние, необходимо перезапустить компьютер. Возможно, потребуется перезагрузить компьютер вручную. |
| **MBAM_E_SHUTDOWN_REQUIRED**<br />2147746309 (0x80040205) | Чтобы установить правильное состояние доверенного платформенного модуля, необходимо выключить и снова включить компьютер. Возможно, потребуется перезагрузить компьютер вручную. |
| **WS_E_ENDPOINT_ACCESS_DENIED**<br />2151481349 (0x803D0005) | Отказано в доступе к удаленной конечной точке. |
| **WS_E_ENDPOINT_NOT_FOUND**<br />2151481357 (0x803D000D) | Удаленная конечная точка не существует или не может быть найдена. |
| * * WS_E_ENDPOINT_FAILURE<br />2151481357 (0x803D000F) | Удаленной конечной точке не удалось обработать запрос. |
| **WS_E_ENDPOINT_UNREACHABLE**<br />2151481360 (0x803D0010) | Удаленная конечная точка была недоступна. |
| **WS_E_ENDPOINT_FAULT_RECEIVED**<br />2151481363 (0x803D0013) | От удаленной конечной точки получено сообщение с ошибкой. Убедитесь, что вы подключаетесь к правильной конечной точке обслуживания. |
| **WS_E_INVALID_ENDPOINT_URL** 2151481376 (0x803D0020) | Недопустимый URL-адрес конечной точки. URL-адрес должен начинаться с "http" или "HTTPS". |

   **ReportStatus:** Считывает состояние соответствия тома и отправляет его в базу данных состояния соответствия MBAM с помощью службы отчетов о состоянии MBAM. Состояние включает стойкость шифра, Тип предохранителя, состояние предохранителя и состояние шифрования. В случае сбоя возвращается код ошибки для устранения неполадок.

   | Параметр | Описание |
   | --------- | ----------- |
   | ReportingServiceEndPoint | Строка, указывающая конечную точку службы отчетов о состоянии MBAM. |

   Ниже перечислены распространенные сообщения об ошибках.

   | Общие возвращаемые значения | Сообщение об ошибке |
   | -------------------- | ------------- |
   | **S_OK**<br /> 0 (0x0) | Метод успешно выполнен |
   | **WS_E_ENDPOINT_ACCESS_DENIED**<br />2151481349 (0x803D0005) | Отказано в доступе к удаленной конечной точке.|
   | **WS_E_ENDPOINT_NOT_FOUND**<br />2151481357 (0x803D000D) | Удаленная конечная точка не существует или не может быть найдена. |
   | **WS_E_ENDPOINT_FAILURE**<br /> 2151481357 (0x803D000F) | Удаленной конечной точке не удалось обработать запрос. |
   | **WS_E_ENDPOINT_UNREACHABLE**<br />2151481360 (0x803D0010) | Удаленная конечная точка была недоступна. |
   | **WS_E_ENDPOINT_FAULT_RECEIVED**<br />2151481363 (0x803D0013) | От удаленной конечной точки получено сообщение с ошибкой. Убедитесь, что вы подключаетесь к правильной конечной точке обслуживания. |
   | **WS_E_INVALID_ENDPOINT_URL**<br />2151481376 (0x803D0020) | Недопустимый URL-адрес конечной точки. URL-адрес должен начинаться с "http" или "HTTPS". |

   <a href="" id="mbam-volume-wmi-class"></a>**MBAM \ _Volume EscrowRecoveryKey классов WMI** **:** считывает числовой пароль восстановления и ключевой пакет тома и отправляет их в базу данных восстановления MBAM с помощью службы восстановления MBAM. В случае сбоя возвращается код ошибки для устранения неполадок.

   | Параметр | Описание |
   | --------- | ----------- |
   | RecoveryServiceEndPoint | Строка, указывающая конечную точку службы восстановления MBAM. |

   Ниже перечислены распространенные сообщения об ошибках.

   | Общие возвращаемые значения | Сообщение об ошибке |
   | -------------------- | ------------- |
   | **S_OK**<br />0 (0x0) | Метод успешно выполнен |
   | **FVE_E_LOCKED_VOLUME**<br />2150694912 (0x80310000) | Том заблокирован. |
   | **FVE_E_PROTECTOR_NOT_FOUND**<br />2150694963 (0x80310033) | Для этого тома не найден предохранитель для числового пароля. |
   | **WS_E_ENDPOINT_ACCESS_DENIED**<br />2151481349 (0x803D0005) | Отказано в доступе к удаленной конечной точке. |
   | **WS_E_ENDPOINT_NOT_FOUND**<br />2151481357 (0x803D000D) | Удаленная конечная точка не существует или не может быть найдена. |
   | **WS_E_ENDPOINT_FAILURE**<br />2151481357 (0x803D000F) | Удаленной конечной точке не удалось обработать запрос. |
   | **WS_E_ENDPOINT_UNREACHABLE**<br />2151481360 (0x803D0010) | Удаленная конечная точка была недоступна. |
   | **WS_E_ENDPOINT_FAULT_RECEIVED**<br />2151481363 (0x803D0013) | От удаленной конечной точки получено сообщение с ошибкой. Убедитесь, что вы подключаетесь к правильной конечной точке обслуживания. |
   | **WS_E_INVALID_ENDPOINT_URL**<br />2151481376 (0x803D0020) | Недопустимый URL-адрес конечной точки. URL-адрес должен начинаться с "http" или "HTTPS". |
     

2. **Развертывание MBAM с помощью набора средств развертывания Microsoft (MDT) и оболочки PowerShell**

   1.  В MDT создайте новый общий доступ к развертыванию или откройте существующий общий доступ к развертыванию.

       **Примечание.**  
       `Invoke-MbamClientDeployment.ps1`Сценарий PowerShell можно использовать с любыми другими процессами или средствами обработки изображений. В этом разделе показано, как интегрировать его с помощью MDT, но эти действия похожи на интеграцию с любым другим процессом или инструментом.

       **Осторожны**  
       Если вы используете предварительную подготовку BitLocker и хотите сохранить значение авторизации владельца доверенного платформенного модуля, необходимо добавить `SaveWinPETpmOwnerAuth.wsf` сценарий в WinPE сразу же после перезагрузки установки в полную операционную систему. **Если вы не используете этот сценарий, значение авторизации владельца доверенного платформенного модуля будет потеряно при перезагрузке.**

   2.  Скопировать `Invoke-MbamClientDeployment.ps1` в ** &lt; DeploymentShare &gt; \\Scripts**. Если вы используете предварительную подготовку, скопируйте `SaveWinPETpmOwnerAuth.wsf` файл в ** &lt; DeploymentShare &gt; \\Scripts**.

   3.  Добавьте клиентское приложение MBAM 2,5 с пакетом обновления 1 (SP1) в узел приложения в общем доступе к развертыванию.

       1.  В разделе **приложения** нажмите кнопку **новое приложение**.

       2.  Выберите **приложение с исходными файлами**. Нажмите кнопку **Далее**.

       3.  В окне **имя приложения**введите "MBAM 2,5 SP1 Client". Нажмите кнопку **Далее**.

       4.  Перейдите к каталогу, содержащему `MBAMClientSetup-<Version>.msi` . Нажмите кнопку **Далее**.

       5.  В качестве создаваемого каталога введите "MBAM 2,5 SP1 Client". Нажмите кнопку **Далее**.

       6.  Ввод `msiexec /i MBAMClientSetup-<Version>.msi /quiet` в командной строке. Нажмите кнопку **Далее**.

       7.  Чтобы завершить работу мастера создания приложений, подтвердите оставшиеся значения по умолчанию.

   4.  В MDT щелкните правой кнопкой мыши имя общего доступа к развертыванию и выберите пункт **Свойства**. Откройте вкладку **правила** . Добавьте следующие строки:

       `SkipBitLocker=YES``BDEInstall=TPM``BDEInstallSuppress=NO``BDEWaitForEncryption=YES`

       Нажмите кнопку ОК, чтобы закрыть окно.

   5.  В узле последовательности задач измените существующую последовательность задач, используемую для развертывания Windows. При желании вы можете создать новую последовательность задач, щелкнув правой кнопкой мыши узел **последовательности задач** , выбрав команду **создать последовательность задач**и завершая работу мастера.

       На вкладке " **последовательность задач** " выбранной последовательности задач выполните указанные ниже действия.

       1.  В папке **Предварительная установка** включите дополнительные задачи, чтобы **включить BitLocker (не в автономном режиме)** , если вы хотите включить BitLocker в WinPE, которое шифрует только используемое пространство.

       2.  Чтобы сохранить OwnerAuth доверенного платформенного модуля при использовании предварительной подготовки, позволяя MBAM в будущем, выполните указанные ниже действия.

           1.  Ознакомьтесь с шагом по **установке операционной системы**

           2.  Добавление новой **команды запуска из командной строки**

           3.  Назовите этот шаг, чтобы **сохранить OwnerAuth доверенного платформенного модуля**

           4.  Установка `cscript.exe "%SCRIPTROOT%/SaveWinPETpmOwnerAuth.wsf"`
            **заметок** в командной строке: в windows 10 версии 1607 или более поздней — только Windows может стать владельцем доверенного платформенного модуля. В addiiton при подготовке доверенного платформенного модуля Windows не сохранит пароль владельца доверенного платформенного модуля. Дополнительные сведения приведены в разделе [пароль владельца доверенного платформенного модуля](https://docs.microsoft.com/windows/security/hardware-protection/tpm/change-the-tpm-owner-password) .

       3.  В папке **Восстановление состояния** удалите задачу **включения BitLocker** .

       4.  В папке **Восстановление состояния** в разделе **пользовательские задачи**создайте новую задачу **установки приложения** и назовите ее **Install MBAM Agent**. Нажмите кнопку **установить единое приложение** и перейдите к клиентскому приложению MBAM 2,5 с пакетом обновления 1 (SP1), созданному ранее.

       5.  В папке **Восстановление состояния** в разделе **пользовательские задачи**создайте новую задачу **запуска сценария PowerShell** (после шага клиентского приложения MBAM 2,5 SP1) со следующими параметрами (обновите параметры соответствующим образом для вашей среды):

           -   Имя: Настройка BitLocker для MBAM

           -   Сценарий PowerShell: `Invoke-MbamClientDeployment.ps1`

           -   Параметры

               <table>
               <colgroup>
               <col width="33%" />
               <col width="33%" />
               <col width="33%" />
               </colgroup>
               <tbody>
               <tr class="odd">
               <td align="left"><p>-RecoveryServiceEndpoint</p></td>
               <td align="left"><p>Обязательный</p></td>
               <td align="left"><p>Конечная точка службы восстановления MBAM</p></td>
               </tr>
               <tr class="even">
               <td align="left"><p>-StatusReportingServiceEndpoint</p></td>
               <td align="left"><p>Необязательно</p></td>
               <td align="left"><p>Конечная точка службы отчетов о состоянии MBAM</p></td>
               </tr>
               <tr class="odd">
               <td align="left"><p>-EncryptionMethod</p></td>
               <td align="left"><p>Необязательно</p></td>
               <td align="left"><p>Метод шифрования (по умолчанию: AES 128)</p></td>
               </tr>
               <tr class="even">
               <td align="left"><p>-EncryptAndEscrowDataVolume</p></td>
               <td align="left"><p>Переключатель</p></td>
               <td align="left"><p>Укажите, что нужно зашифровать тома данных и ключи восстановления тома для депонированных данных (#d0)</p></td>
               </tr>
               <tr class="odd">
               <td align="left"><p>-WaitForEncryptionToComplete</p></td>
               <td align="left"><p>Переключатель</p></td>
               <td align="left"><p>Ожидание завершения шифрования</p></td>
               </tr>
               <tr class="even">
               <td align="left"><p>-DoNotResumeSuspendedEncryption</p></td>
               <td align="left"><p>Переключатель</p></td>
               <td align="left"><p>Указывает на то, что скрипт развертывания не будет возобновлять приостановку шифрования.</p></td>
               </tr>
               <tr class="odd">
               <td align="left"><p>-IgnoreEscrowOwnerAuthFailure</p></td>
               <td align="left"><p>Переключатель</p></td>
               <td align="left"><p>Укажите, следует игнорировать депонированный отказ владельца доверенного платформенного модуля. Его следует использовать в сценариях, где MBAM не может прочитать владельца доверенного платформенного модуля, например, если включена автоматическая подготовка TPM.</p></td>
               </tr>
               <tr class="even">
               <td align="left"><p>-IgnoreEscrowRecoveryKeyFailure</p></td>
               <td align="left"><p>Переключатель</p></td>
               <td align="left"><p>Указание пропуска депонирования ключа восстановления тома</p></td>
               </tr>
               <tr class="odd">
               <td align="left"><p>-IgnoreReportStatusFailure</p></td>
               <td align="left"><p>Переключатель</p></td>
               <td align="left"><p>Указание пропуска ошибки отчета о состоянии</p></td>
               </tr>
               </tbody>
               </table>

                 

**Включение BitLocker с использованием MBAM 2,5 или более ранней версии в рамках развертывания Windows**

1.  Установите клиент MBAM. Инструкции можно найти в разделе [развертывание клиента MBAM с помощью командной строки](how-to-deploy-the-mbam-client-by-using-a-command-line.md).

2.  Присоединение компьютера к домену (рекомендуется).

    -   Если компьютер не подключен к домену, пароль восстановления не хранится в службе восстановления ключа MBAM. По умолчанию MBAM не поддерживает шифрование, если не удается сохранить ключ восстановления.

    -   Если компьютер запускается в режиме восстановления, прежде чем ключ восстановления будет храниться на сервере MBAM, метод восстановления не будет доступен, и компьютер необходимо будет переобразировать.

3.  Откройте командную команду от имени администратора и остановите службу MBAM.

4.  Настройте службу на **ручной** или **по запросу** , введя указанные ниже команды.

    **NET STOP mbamagent**

    **SC config mbamagent Start = Demand**

5.  Задайте значения в реестре, чтобы клиент MBAM не игнорировал параметры групповой политики, а затем задает шифрование для начала развертывания Windows на этом клиентском компьютере.

    **Внимание!**  В этой статье описано, как изменить реестр Windows. Неправильное использование редактора реестра может привести к серьезным проблемам, которые могут потребовать повторной установки Windows. Мы не можем гарантировать, что проблемы, возникающие в результате неправильного использования редактора реестра, могут быть устранены. Ответственность за использование редактора реестра.

    1.  Настройте доверенный платформенный модуль для **шифрования только для операционной системы**, запустите Regedit.exe, а затем импортируйте шаблон раздела реестра из C:\\program Files Files\\Microsoft\\MDOP MBAM\\MBAMDeploymentKeyTemplate.reg.

    2.  В Regedit.exe перейдите на HKLM\\SOFTWARE\\Microsoft\\MBAM и настройте параметры, указанные в приведенной ниже таблице.

        **Примечание**  Вы можете настроить параметры групповой политики или значения реестра, связанные с MBAM. Эти параметры переопределяют значения, заданные ранее.

        Параметры конфигурации записи в реестре

        DeploymentTime

        0 = Выкл.

        1 = использовать параметры политики времени развертывания (по умолчанию) — Используйте этот параметр, чтобы включить шифрование на момент развертывания Windows на клиентском компьютере.

        UseKeyRecoveryService

        0 = не использовать криптоключ ключа (в этом случае следующие два элемента реестра не требуются).

        1 = использование депонирования ключа в системе восстановления ключей (по умолчанию)

        Это рекомендуемый параметр, который позволяет MBAM хранить ключи восстановления. Компьютер должен поддерживать связь со службой восстановления ключа MBAM. Убедитесь, что компьютер может взаимодействовать со службой, прежде чем продолжить.

        KeyRecoveryOptions

        0 = Отправка только ключа восстановления

        1 = Отправка ключа восстановления и пакета восстановления ключа (по умолчанию)

        KeyRecoveryServiceEndPoint

        Задайте для этого параметра URL-адрес сервера, на котором запущена служба восстановления ключей, например http:// &lt; имя компьютера &gt; /MBAMRecoveryAndHardwareService/CoreService.svc.


6.  Клиент MBAM перезапустит систему во время развертывания клиента MBAM. Когда вы будете готовы к этому перезапуску, выполните следующую команду в командной строке с правами администратора:

    **NET start mbamagent**

7.  После перезапуска компьютера и BIOS с запросом на подтверждение измените доверенный платформенный модуль.

8.  В процессе обработки образа операционной системы клиента Windows, когда вы будете готовы приступить к шифрованию, откройте командную команду от имени администратора и введите следующие команды, чтобы установить **Автоматический** запуск агента клиента MBAM:

    **SC config mbamagent Start = Auto**

    **NET start mbamagent**

9.  Чтобы удалить пропущенные значения в реестре, запустите Regedit.exe и перейдите к записи в реестре HKLM\\SOFTWARE\\Microsoft. Щелкните правой кнопкой мыши узел **MBAM** и выберите команду **Удалить**.

## Статьи по теме

[Развертывание клиента MBAM 2.5](deploying-the-mbam-25-client.md)

[Планирование развертывания клиента MBAM 2.5](planning-for-mbam-25-client-deployment.md)

## У вас есть предложение MBAM?
- Здесь вы можете добавить предложения и проголосовать [здесь](http://mbam.uservoice.com/forums/268571-microsoft-bitlocker-administration-and-monitoring).
- Для MBAM проблемы используйте [MBAM Форум TechNet](https://social.technet.microsoft.com/Forums/home?forum=mdopmbam).
