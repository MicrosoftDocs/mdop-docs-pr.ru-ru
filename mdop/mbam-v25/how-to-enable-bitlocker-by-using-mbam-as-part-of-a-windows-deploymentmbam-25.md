---
title: Включение BitLocker с помощью MBAM в составе развертывания Windows
description: Включение BitLocker с помощью MBAM в составе развертывания Windows
author: dansimp
ms.assetid: 7609ad7a-bb06-47be-b186-0a2db787c8a5
ms.reviewer: ''
manager: dansimp
ms.author: dansimp
ms.pagetype: mdop, security
ms.mktglfcycl: manage
ms.sitesec: library
ms.prod: w10
ms.date: 04/23/2017
ms.openlocfilehash: cd4086ca6bb2ea8d253ea3b743f4efe7efbbb6c1
ms.sourcegitcommit: 325c4b77f9a9df0f3de268457fed06184623bb94
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/30/2021
ms.locfileid: "11626186"
---
# <a name="how-to-enable-bitlocker-by-using-mbam-as-part-of-a-windows-deployment"></a>Включение BitLocker с помощью MBAM в составе развертывания Windows

> [!IMPORTANT]
> Эти инструкции не относятся к диспетчеру конфигурации BitLocker Management. Скрипт `Invoke-MbamClientDeployment.ps1` PowerShell не поддерживается для использования с помощью BitLocker Management в Configuration Manager. Это включает в себя депонацию ключей восстановления BitLocker во время последовательности задач Configuration Manager. Кроме того, начиная с текущего филиала 2103 configuration Manager BitLocker Management больше не использует сайт служб восстановления ключей MBAM для ключей escrow. Попытка использования сценария PowerShell с помощью конфигурации Manager Current Branch 2103 или более нового может привести к серьезным проблемам с сайтом `Invoke-MbamClientDeployment.ps1` Configuration Manager. Известные проблемы включают создание большого количества политик, нацеленных на все устройства, которые могут вызывать штормы политики. Это приведет к серьезной деградации производительности в Configuration Manager, главным образом в SQL и с точкими управления.

В этом разделе объясняется, как включить BitLocker на компьютере конечного пользователя с помощью MBAM в Windows и процесса развертывания. Если при перезапуске (после завершения этапа установки) вы увидите черный экран, указывающий, что диск не может быть разблокирован, см. статью Более ранние версии Windows не запускаются после шага "Настройка Windows и диспетчер конфигурации", если предварительное приложение BitLocker используется с Windows 10, версия [1511](https://support.microsoft.com/en-us/help/4494799/earlier-windows-versions-don-t-start-after-you-use-pre-provision-bitlo).

**Необходимые условия**

-   Должен быть Windows процесс развертывания изображений — microsoft Deployment набор средств (MDT), Microsoft System Center Configuration Manager или какой-либо другой инструмент или процесс визуализации.

-   TPM должен быть включен в BIOS и виден для ОС

-   Инфраструктура сервера MBAM должна быть на месте и доступна

-   Необходимо создать раздел системы, необходимый BitLocker

-   Машина должна быть соединена с доменом во время визуализации, прежде чем MBAM полностью включает BitLocker

**Включить BitLocker с помощью MBAM 2.5 SP1 в рамках Windows развертывания**

1. В MBAM 2.5 SP1 рекомендуется включить BitLocker во время развертывания Windows с помощью сценария `Invoke-MbamClientDeployment.ps1` PowerShell.

   -   Сценарий `Invoke-MbamClientDeployment.ps1` вводит BitLocker во время процесса визуализации. Когда это требуется политикой BitLocker, агент MBAM немедленно побуждает пользователя домена создать ПИН-код или пароль, когда пользователь домена впервые войдет в систему после обработки изображений.

   -   Простой в использовании с процессами MDT, System Center Configuration Manager или автономных изображений

   -   Совместимый с PowerShell 2.0 или выше

   -   Шифрование тома ОС с помощью защитника ключа TPM

   -   Полностью поддерживает предварительную подготовку BitLocker

   -   Необязательный шифрование FDD

   -   Владелец Escrow TPM Для Windows 7, MBAM должен владеть TPM для возникновения эскроу.
   Для Windows 8.1, Windows 10 RTM и Windows 10 версии 1511 поддерживается эскроу TPM OwnerAuth.
   Для Windows 10 версии 1607 или более поздней версии Windows может взять на себя право собственности на TPM. В addiiton Windows не сохранит пароль владельца TPM при обеспечении TPM. Дополнительные сведения см. в пароле владельца [TPM.](https://docs.microsoft.com/windows/security/hardware-protection/tpm/change-the-tpm-owner-password)

   -   Ключи восстановления Escrow и пакеты ключей восстановления

   -   Немедленно сообщить о состоянии шифрования

   -   Новые поставщики WMI

   -   Подробный журнал

   -   Надежная обработка ошибок

   Вы можете скачать `Invoke-MbamClientDeployment.ps1` сценарий [из центра Microsoft.com загрузки](https://www.microsoft.com/download/details.aspx?id=54439). Это основной сценарий, который будет вызываться системой развертывания для настройки шифрования дисков BitLocker и записи ключей восстановления с помощью MBAM Server.

   **Методы развертывания WMI для MBAM:** В MBAM 2.5 SP1 добавлены следующие методы WMI для поддержки включения BitLocker с помощью сценария `Invoke-MbamClientDeployment.ps1` PowerShell.

   <a href="" id="mbam-machine-wmi-class"></a>**MBAM\_Machine WMI Class** 
    **PrepareTpmAndEscrowOwnerAuth:** Читает TPM OwnerAuth и отправляет его в базу данных восстановления MBAM с помощью службы восстановления MBAM. Если TPM не принадлежит и автозапявка не предусмотрена, она создает TPM OwnerAuth и берет на себя право собственности. В случае с ошибкой возвращается код ошибки для устранения неполадок.

   **Примечание** Для Windows 10 версии 1607 или более поздней версии Windows может взять на себя право собственности на TPM. В addiiton Windows не сохранит пароль владельца TPM при обеспечении TPM. Дополнительные сведения см. в пароле владельца [TPM.](https://docs.microsoft.com/windows/security/hardware-protection/tpm/change-the-tpm-owner-password)

| Параметр | Описание |
| -------- | ----------- |
| RecoveryServiceEndPoint | Строка с указанием конечной точки службы восстановления MBAM. |

Вот список распространенных сообщений об ошибках:

| Общие значения возврата | Сообщение об ошибке |
| -------------------- | ------------- |
|  **S_OK**<br />0 (0x0) | Метод был успешным. |
| **MBAM_E_TPM_NOT_PRESENT**<br />2147746304 (0x80040200) | TPM не присутствует на компьютере или отключена в конфигурации BIOS. |
| **MBAM_E_TPM_INCORRECT_STATE**<br />2147746305 (0x80040201) | TPM находится не в правильном состоянии (разрешена включенная, активированная и разрешенная установка владельца). |
| **MBAM_E_TPM_AUTO_PROVISIONING_PENDING**<br />2147746306 (0x80040202) | MBAM не может взять на себя ответственность за TPM, так как автоматическая подготовка еще не завершена. Попробуйте еще раз после завершения автоматической подготовка. |
| **MBAM_E_TPM_OWNERAUTH_READFAIL**<br />2147746307 (0x80040203) | MBAM не может прочитать значение авторизации владельца TPM. Это значение могло быть удалено после успешной сделки. На Windows 7, MBAM не может прочитать значение, если TPM принадлежит другим. |
| **MBAM_E_REBOOT_REQUIRED**<br />2147746308 (0x80040204) | Компьютер необходимо перезапустить, чтобы установить TPM в нужном состоянии. Может потребоваться ручная перезагрузка компьютера. |
| **MBAM_E_SHUTDOWN_REQUIRED**<br />2147746309 (0x80040205) | Компьютер должен быть отключен и включен, чтобы установить TPM в нужном состоянии. Может потребоваться ручная перезагрузка компьютера. |
| **WS_E_ENDPOINT_ACCESS_DENIED**<br />2151481349 (0x803D0005) | Удаленная конечная точка отказано в доступе. |
| **WS_E_ENDPOINT_NOT_FOUND**<br />2151481357 (0x803D000D) | Удаленная конечная точка не существует или не может быть расположена. |
| **WS_E_ENDPOINT_FAILURE<br />2151481357 (0x803D000F) | Удаленная конечная точка не может обрабатывать запрос. |
| **WS_E_ENDPOINT_UNREACHABLE**<br />2151481360 (0x803D0010) | Удаленная конечная точка недоступна. |
| **WS_E_ENDPOINT_FAULT_RECEIVED**<br />2151481363 (0x803D0013) | Сообщение, содержащее ошибку, было получено из удаленной конечной точки. Убедитесь, что вы подключались к правильной конечной точке службы. |
| **WS_E_INVALID_ENDPOINT_URL** 2151481376 (0x803D0020) | URL-адрес конечной точки не является допустимым. URL-адрес должен начинаться с "http" или "https". |

   **ReportStatus:** Считываю состояние соответствия тому и отправляем его в базу данных о состоянии соответствия требованиям MBAM с помощью службы отчетности о состоянии MBAM. Состояние включает силу шифра, тип защитника, состояние защитника и состояние шифрования. В случае с ошибкой возвращается код ошибки для устранения неполадок.

   | Параметр | Описание |
   | --------- | ----------- |
   | ReportingServiceEndPoint | Строка с указанием конечной точки службы отчетов о состоянии MBAM. |

   Вот список распространенных сообщений об ошибках:

   | Общие значения возврата | Сообщение об ошибке |
   | -------------------- | ------------- |
   | **S_OK**<br /> 0 (0x0) | Метод был успешным |
   | **WS_E_ENDPOINT_ACCESS_DENIED**<br />2151481349 (0x803D0005) | Удаленная конечная точка отказано в доступе.|
   | **WS_E_ENDPOINT_NOT_FOUND**<br />2151481357 (0x803D000D) | Удаленная конечная точка не существует или не может быть расположена. |
   | **WS_E_ENDPOINT_FAILURE**<br /> 2151481357 (0x803D000F) | Удаленная конечная точка не может обрабатывать запрос. |
   | **WS_E_ENDPOINT_UNREACHABLE**<br />2151481360 (0x803D0010) | Удаленная конечная точка недоступна. |
   | **WS_E_ENDPOINT_FAULT_RECEIVED**<br />2151481363 (0x803D0013) | Сообщение, содержащее ошибку, было получено из удаленной конечной точки. Убедитесь, что вы подключались к правильной конечной точке службы. |
   | **WS_E_INVALID_ENDPOINT_URL**<br />2151481376 (0x803D0020) | URL-адрес конечной точки не является допустимым. URL-адрес должен начинаться с "http" или "https". |

   <a href="" id="mbam-volume-wmi-class"></a>**MBAM\_Volume класса WMI** **EscrowRecoveryKey:** считываю численное пароль восстановления и пакет ключей тома и отправляет их в базу данных восстановления MBAM с помощью службы восстановления MBAM. В случае с ошибкой возвращается код ошибки для устранения неполадок.

   | Параметр | Описание |
   | --------- | ----------- |
   | RecoveryServiceEndPoint | Строка с указанием конечной точки службы восстановления MBAM. |

   Вот список распространенных сообщений об ошибках:

   | Общие значения возврата | Сообщение об ошибке |
   | -------------------- | ------------- |
   | **S_OK**<br />0 (0x0) | Метод был успешным |
   | **FVE_E_LOCKED_VOLUME**<br />2150694912 (0x80310000) | Громкость заблокирована. |
   | **FVE_E_PROTECTOR_NOT_FOUND**<br />2150694963 (0x80310033) | Числовая защита пароля не была найдена для тома. |
   | **WS_E_ENDPOINT_ACCESS_DENIED**<br />2151481349 (0x803D0005) | Удаленная конечная точка отказано в доступе. |
   | **WS_E_ENDPOINT_NOT_FOUND**<br />2151481357 (0x803D000D) | Удаленная конечная точка не существует или не может быть расположена. |
   | **WS_E_ENDPOINT_FAILURE**<br />2151481357 (0x803D000F) | Удаленная конечная точка не может обрабатывать запрос. |
   | **WS_E_ENDPOINT_UNREACHABLE**<br />2151481360 (0x803D0010) | Удаленная конечная точка недоступна. |
   | **WS_E_ENDPOINT_FAULT_RECEIVED**<br />2151481363 (0x803D0013) | Сообщение, содержащее ошибку, было получено из удаленной конечной точки. Убедитесь, что вы подключались к правильной конечной точке службы. |
   | **WS_E_INVALID_ENDPOINT_URL**<br />2151481376 (0x803D0020) | URL-адрес конечной точки не является допустимым. URL-адрес должен начинаться с "http" или "https". |
     

2. **Развертывание MBAM с помощью microsoft Deployment набор средств (MDT) и PowerShell**

   1.  В MDT создайте новую долю развертывания или откройте существующую долю развертывания.

       **Примечание.**  
       Скрипт `Invoke-MbamClientDeployment.ps1` PowerShell можно использовать с любым процессом обработки изображений или инструментом. В этом разделе показано, как интегрировать его с помощью MDT, но действия аналогичны интеграции с любым другим процессом или инструментом.

       **Предостережение**  
       Если вы используете предварительную подготовку BitLocker (WinPE) и хотите сохранить значение авторизации владельца TPM, необходимо добавить скрипт в WinPE непосредственно перед перезагрузкой установки в полную операционную `SaveWinPETpmOwnerAuth.wsf` систему. **Если этот сценарий не используется, при перезагрузке потеряет значение авторизации владельца TPM.**

   2.  `Invoke-MbamClientDeployment.ps1`Скопируйте ** &lt; в DeploymentShare &gt; \\Scripts**. Если вы используете предварительную подготовку, скопируйте файл в `SaveWinPETpmOwnerAuth.wsf` ** &lt; DeploymentShare &gt; \\Scripts.**

   3.  Добавьте клиентские приложения MBAM 2.5 SP1 в узел Applications в совместном развертывании.

       1.  В **узле Приложения** нажмите **кнопку Новое приложение**.

       2.  Выберите **приложение с исходными файлами.** Нажмите кнопку **Далее**.

       3.  В **имя приложения**введите "MBAM 2.5 SP1 Client". Нажмите кнопку **Далее**.

       4.  Просмотрите каталог, содержащий `MBAMClientSetup-<Version>.msi` . Нажмите кнопку **Далее**.

       5.  Введите "MBAM 2.5 SP1 Client" в качестве создаваемого каталога. Нажмите кнопку **Далее**.

       6.  Введите `msiexec /i MBAMClientSetup-<Version>.msi /quiet` в командной строке. Нажмите кнопку **Далее**.

       7.  Примите оставшиеся по умолчанию для завершения мастера нового приложения.

   4.  В MDT щелкните правой кнопкой мыши имя доли развертывания и щелкните **Свойства**. Щелкните **вкладку Правила.** Добавьте следующие строки:

       `SkipBitLocker=YES``BDEInstall=TPM``BDEInstallSuppress=NO``BDEWaitForEncryption=YES`

       Нажмите кнопку ОК, чтобы закрыть окно.

   5.  В узле Последовательности задач отредактировать существующую последовательность задач, используемую для Windows развертывания. Если хотите, вы можете создать новую последовательность задач, щелкнув правой кнопкой мыши узел Последовательности задач, выбрав новую последовательность задач **и**завершив мастер. ****

       На **вкладке Последовательность** задач выбранной последовательности задач выполните следующие действия:

       1.  В **папке Preinstall** включайте необязательные задачи **Включить BitLocker (автономно),** если вы хотите включить BitLocker в WinPE, который шифрует только используемую площадь.

       2.  Чтобы сохранить TPM OwnerAuth при использовании предварительной подготовки, позволяя MBAM использовать его позже, сделайте следующее:

           1.  Найдите **шаг установки операционной** системы

           2.  Добавление нового шага **командной строки запуска** после него

           3.  Назови шаг **Упорядный TPM OwnerAuth**

           4.  Установите командную строку `cscript.exe "%SCRIPTROOT%/SaveWinPETpmOwnerAuth.wsf"`
            **Примечание.** Для Windows 10 версии 1607 или более поздней версии Windows может взять на себя право собственности на TPM. В addiiton Windows не сохранит пароль владельца TPM при обеспечении TPM. Дополнительные сведения см. в пароле владельца [TPM.](https://docs.microsoft.com/windows/security/hardware-protection/tpm/change-the-tpm-owner-password)

       3.  В **папке Восстановление** состояния удалите задачу **Включить bitLocker.**

       4.  В **папке State Restore** в **настраиваемые**задачи создайте новую задачу **Установки** приложения и назови ее **Install MBAM Agent**. Щелкните **кнопку Установка единого** приложения и просмотрите клиентское приложение MBAM 2.5 SP1, созданное ранее.

       5.  В папке State **** **Restore** в настраиваемые задачи создайте новую задачу Сценарий **Run PowerShell** (после шага клиентского приложения MBAM 2.5 SP1) со следующими параметрами (обновите параметры, соответствующие вашей среде):

           -   Имя: Настройка BitLocker для MBAM

           -   Сценарий PowerShell: `Invoke-MbamClientDeployment.ps1`

           -   Параметры:

               <table>
               <colgroup>
               <col width="33%" />
               <col width="33%" />
               <col width="33%" />
               </colgroup>
               <tbody>
               <tr class="odd">
               <td align="left"><p>-RecoveryServiceEndpoint</p></td>
               <td align="left"><p>Обязательный</p></td>
               <td align="left"><p>Конечная точка службы восстановления MBAM</p></td>
               </tr>
               <tr class="even">
               <td align="left"><p>-StatusReportingServiceEndpoint</p></td>
               <td align="left"><p>Необязательно</p></td>
               <td align="left"><p>Конечная точка службы отчетов о состоянии MBAM</p></td>
               </tr>
               <tr class="odd">
               <td align="left"><p>-EncryptionMethod</p></td>
               <td align="left"><p>Необязательно</p></td>
               <td align="left"><p>Метод шифрования (по умолчанию: AES 128)</p></td>
               </tr>
               <tr class="even">
               <td align="left"><p>-EncryptAndEscrowDataVolume</p></td>
               <td align="left"><p>Переключатель</p></td>
               <td align="left"><p>Укажите для шифрования ключа восстановления громкости данных (s) и ключа восстановления объема данных на эскроу(s)</p></td>
               </tr>
               <tr class="odd">
               <td align="left"><p>-WaitForEncryptionToComplete</p></td>
               <td align="left"><p>Переключатель</p></td>
               <td align="left"><p>Укажите, чтобы дождаться завершения шифрования</p></td>
               </tr>
               <tr class="even">
               <td align="left"><p>-DoNotResumeSuspendedEncryption</p></td>
               <td align="left"><p>Переключатель</p></td>
               <td align="left"><p>Укажите, что сценарий развертывания не будет возобновлять приостановленное шифрование</p></td>
               </tr>
               <tr class="odd">
               <td align="left"><p>-IgnoreEscrowOwnerAuthFailure</p></td>
               <td align="left"><p>Переключатель</p></td>
               <td align="left"><p>Укажите, чтобы игнорировать отказ от эскроу-счета владельца TPM. Его следует использовать в сценариях, в которых MBAM не может читать автозапев TPM, например, если включена автозапевка TPM.</p></td>
               </tr>
               <tr class="even">
               <td align="left"><p>-IgnoreEscrowRecoveryKeyFailure</p></td>
               <td align="left"><p>Переключатель</p></td>
               <td align="left"><p>Укажите, чтобы игнорировать отказ от сбоя escrow ключа восстановления тома</p></td>
               </tr>
               <tr class="odd">
               <td align="left"><p>-IgnoreReportStatusFailure</p></td>
               <td align="left"><p>Переключатель</p></td>
               <td align="left"><p>Укажите, чтобы игнорировать сбой отчетов о состоянии</p></td>
               </tr>
               </tbody>
               </table>

                 

**Включить BitLocker с помощью MBAM 2.5 или ранее в рамках Windows развертывания**

1.  Установка клиента MBAM. Инструкции см. [в инструкции По развертыванию клиента MBAM с помощью командной строки.](how-to-deploy-the-mbam-client-by-using-a-command-line.md)

2.  Присоединитесь к компьютеру к домену (рекомендуется).

    -   Если компьютер не присоединяется к домену, пароль восстановления не хранится в службе восстановления ключей MBAM. По умолчанию MBAM не позволяет шифрование, если ключ восстановления не может храниться.

    -   Если компьютер запускается в режиме восстановления перед хранением ключа восстановления на сервере MBAM Server, метод восстановления не доступен, и компьютер должен быть переопроверяться.

3.  Откройте командную подсказку в качестве администратора и остановите службу MBAM.

4.  Установите службу **вручную** или **по требованию,** введя следующие команды:

    **net stop mbamagent**

    **sc config mbamagent start= demand**

5.  Установите значения реестра таким образом, чтобы клиент MBAM игнорирует параметры групповой политики и вместо этого задает шифрование для запуска времени развертывания Windows на клиентском компьютере.

    **Предостережение**  
    На этом шаге описывается изменение Windows реестра. Неправильное использование редактора реестра может вызвать серьезные проблемы, которые могут потребовать переустановки Windows. Мы не можем гарантировать, что проблемы, выявимые из-за неправильного использования редактора реестра, могут быть устранены. Используйте редактор реестра на свой собственный риск.

    1.  Установите только шифрование TPM для операционной **системы,** запустите Regedit.exe, а затем импортируете шаблон ключа реестра из C:\\Program Files\\Microsoft\\MDOP MBAMMDeploymentKeyTemplate.reg.

    2.  В Regedit.exe перейдите в HKLM\\SOFTWARE\\Microsoft\\MBAM и настройте параметры, перечисленные в следующей таблице.

        **Примечание.**  
        Здесь можно установить параметры групповой политики или значения реестра, связанные с MBAM. Эти параметры переопределяют ранее заданные значения.

        Параметры конфигурации входа в реестр

        DeploymentTime

        0 = Отключено

        1 = Используйте параметры политики времени развертывания (по умолчанию) — используйте этот параметр, чтобы включить шифрование во время развертывания Windows на клиентский компьютер.

        UseKeyRecoveryService

        0 = Не используйте ключ escrow (в этом случае не требуются следующие два записи реестра)

        1 = Использование залога в системе восстановления ключей (по умолчанию)

        Это рекомендуемый параметр, который позволяет MBAM хранить ключи восстановления. Компьютер должен иметь возможность связи со службой восстановления ключей MBAM. Убедитесь, что компьютер может взаимодействовать со службой перед началом работы.

        KeyRecoveryOptions

        0 = Только клавиша восстановления загрузки

        1 = Uploads Recovery Key and Key Recovery Package (default)

        KeyRecoveryServiceEndPoint

        Задай это значение URL-адресу сервера, на которого работает служба восстановления ключей, например http:// имя компьютера &lt; &gt; /MBAMRecoveryAndHardwareService/CoreService.svc.


6.  Клиент MBAM перезапустит систему во время развертывания клиента MBAM. Когда вы будете готовы к этому перезапуску, запустите следующую команду по командной подсказке в качестве администратора:

    **net start mbamagent**

7.  Когда компьютеры перезапуска и BIOS подсказок вам, примите изменение TPM.

8.  Во время Windows процесса визуализации клиентской операционной системы, когда вы готовы начать шифрование, откройте командную подсказку **** в качестве администратора и введите следующие команды, чтобы установить начало работы с автоматическим и перезапустить агент клиента MBAM:

    **sc config mbamagent start= auto**

    **net start mbamagent**

9.  Чтобы удалить значения реестра обхода, запустите Regedit.exe и перейдите к записи реестра HKLM\\SOFTWARE\\Microsoft. Щелкните правой кнопкой **мыши узел MBAM** и нажмите кнопку **Удалить**.

## <a name="related-topics"></a>Статьи по теме

[Развертывание клиента MBAM 2.5](deploying-the-mbam-25-client.md)

[Планирование развертывания клиента MBAM 2.5](planning-for-mbam-25-client-deployment.md)

## <a name="got-a-suggestion-for-mbam"></a>Есть предложение для MBAM?
- Добавьте или проголосуйте по [предложениям здесь](http://mbam.uservoice.com/forums/268571-microsoft-bitlocker-administration-and-monitoring).
- Для решения проблем MBAM используйте [форум MBAM TechNet.](https://social.technet.microsoft.com/Forums/home?forum=mdopmbam)
