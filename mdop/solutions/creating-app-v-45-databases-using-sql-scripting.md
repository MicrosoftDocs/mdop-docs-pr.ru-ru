---
title: Создание баз данных App-V 4.5 с помощью сценариев SQL
description: Создание баз данных App-V 4.5 с помощью сценариев SQL
author: dansimp
ms.assetid: 6cd0b180-163e-463f-a658-939ab9a7cfa1
ms.reviewer: ''
manager: dansimp
ms.author: dansimp
ms.pagetype: mdop
ms.mktglfcycl: deploy
ms.sitesec: library
ms.prod: w10
ms.date: 06/16/2016
ms.openlocfilehash: d9ab2c102a43701bfdeaac49359b4ca3c4a063fa
ms.sourcegitcommit: 354664bc527d93f80687cd2eba70d1eea024c7c3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/26/2020
ms.locfileid: "10825979"
---
# Создание баз данных App-V 4.5 с помощью сценариев SQL


**Для кого предназначено это решение?** Специалисты по информационным технологиям, управляющие базами данных Application Virtualization (App-V) 4,5.

**Как это руководство поможет вам?** Это решение описывает и документирует процедуры для установки сервера Application Virtualization, если администратор не имеет привилегий sysadmin для сервера SQL Server.

## Обзор


Одной из проблем, возникающих при установке Microsoft Application Virtualization 4,5 (App-V), является то, что пользователь, устанавливающий компоненты сервера, не только является администратором локального компьютера, но и обладает правами администратора SQL на сервере SQL Server, на котором будет размещено хранилище данных. Это требование основано на том факте, что база данных, а также соответствующие роли и разрешения создаются как часть установки. Тем не менее, в большинстве организаций серверы SQL Server управляются отдельно от группы инфраструктуры, в которой будет устанавливаться приложение App-V. Эти требования безопасности затрудняют получение администраторами SQL разрешений, необходимых для установки и предоставления администратором инфраструктуры. Аналогичным образом у администраторов SQL не будет разрешений, необходимых для установки продукта для группы инфраструктуры.

В настоящее время у администратора, пытающегося установить приложение App-V, должны быть полномочия SQL "sysadmin". В предыдущих версиях продукта Настройка, разрешенная для администраторов SQL, может либо создать временную учетную запись системного администратора, либо присутствовать во время установки, чтобы предоставить учетные данные с правами администратора. В этом выпуске сценарии предоставляются в выпущенном продукте для всех администраторов, которые будут использоваться при реализации инфраструктуры.

В этом документе обсуждается сценарий, в котором установка должна быть разделена на две отдельных задачи: создание базы данных SQL и установка функций сервера App-V. Администраторы SQL могут просматривать сценарии SQL и вносить изменения для устранения конфликтов с другими базами данных или для поддержки интеграции с другими инструментами. В результате сценариев можно разрешить администраторам SQL подготовить базу данных, чтобы администраторам инфраструктуры не придавались дополнительные права на доступ к SQL Server. Это важно в средах, в которых политики безопасности не будут блокироваться.

### Процесс создания базы данных SQL

Скрипты SQL позволяют администраторам SQL создавать требуемую базу данных, а также настраивать разрешения для администраторов App-V для успешной установки и управления средой. Инструкции по выполнению этих задач описаны ниже в этом документе.

Этот процесс разделяет действия по созданию базы данных и настройке из фактического экземпляра App-V.

**Данные, которые необходимо предоставить администраторам SQL**

-   Имя группы рекламных объявлений, которая должна быть администратором App-V

-   Имя сервера, на котором будет установлен сервер управления App-V

**Информация, возвращаемая администраторам инфраструктуры**

-   Имя сервера или экземпляра базы данных, а также имя базы данных App-V.

После подготовки базы данных Администраторы App-V смогут выполнить установку App-V без прав администратора SQL.

### Использование сценариев настройки SQL

**Требования**

Ниже приведен список требований для использования сценариев, которые находятся в папке support\\createdb в корне выбранного расположения для извлечения.

-   Сценарии необходимо скопировать в расположении, доступном для записи, на компьютере, на котором они будут запускаться (не забудьте удалить атрибут "только для чтения", после того как они были скопированы), и на этом компьютере должны быть загружены инструменты SQL-клиента (osql — требуется только для запуска примеров пакетных файлов на локальном компьютере).

-   Сервер SQL Server должен поддерживать проверку подлинности Windows.

-   Убедитесь, что экземпляр SQL Server и служба агента SQL Server запущены.

-   Войдите в систему с учетной записью домена, которая является администратором SQL (sysadmin) на компьютере, на котором будут выполняться сценарии.

Сценарии выполняются в учетных данных пользователя, вошедшего в систему.

**Создание базы данных с помощью сценариев SQL**

**Задачи, которые должны выполняться администраторами SQL:**

1.  Скопируйте сценарии, содержащиеся в папке support\\createdb, из корня выбранного расположения для извлечения на компьютер, на котором будут выполняться сценарии. Следующие файлы необходимы для правильной работы сценариев и должны вызываться в том порядке, в котором они представлены ниже.

    -   Database. SQL

    -   Roles. SQL

    -   Таблица \ _CODES. SQL

    -   функции \ _before \ _tables. SQL

    -   Tables. SQL

    -   функции. SQL

    -   views. SQL

    -   процедуры. SQL

    -   triggers. SQL

    -   данные \ _codes. SQL

    -   данные \ _messages. SQL

    -   данные \ _defaults. SQL

    -   Alerts \ _jobs. SQL

    -   DBVersion. SQL

2.  Просмотр и изменение файла в случае необходимости `database.sql` . Параметры по умолчанию будут присвоены имя базе данных "APPVIRTDB".

    -   При необходимости замените экземпляры `APPVIRTDB` на `database name` , которые будут использоваться.

    -   Измените `FILENAME` свойство в сценарии, указав соответствующий путь для сервера SQL Server, на котором будет создана база данных.

3.  При необходимости проверьте и измените `database name [APPVIRTDB]` `roles.sql` файл в файле Database. SQL.

****

### Пример автоматизации процесса с помощью пакетных файлов

При использовании из двух примеров пакетных файлов, указанных ниже, выполняются сценарии SQL следующим образом:

1.  **Create\_schema.bat (1)**

    -   Database. SQL

    -   Roles. SQL

2.  **Create\_tables.bat (2)**

    -   Таблица \ _CODES. SQL

    -   функции \ _before \ _tables. SQL

    -   Tables. SQL

    -   функции. SQL

    -   views. SQL

    -   процедуры. SQL

    -   triggers. SQL

    -   данные \ _codes. SQL

    -   данные \ _messages. SQL

    -   данные \ _defaults. SQL

    -   Alerts \ _jobs. SQL

    -   DBVersion. SQL

**Примечание.**  
Будьте внимательны при изменении сценариев и должны быть выполнены только кем-то, у кого есть соответствующие знания. Кроме того, в примерах файлов должны быть изменены только следующие: **create\_schema.bat**, **create\_tables.bat**, **Database. SQL**и **roles. SQL**. Любые другие файлы не должны изменяться каким-либо образом, так как это может привести к тому, что база данных будет создана неправильно, что приводит к сбою установки служб App-V.



Два примера пакетных файлов должны располагаться в том же каталоге, где были скопированы остальные сценарии SQL на компьютере.

1.  Запустите образец файла **create\_schema.bat** , чтобы создать базу данных. Выполнение сценария займет несколько секунд, и его не следует прерывать.

    -   Запустите файл CREATE schema.bat из каталога, в который он был скопирован. Синтаксис: "Create\_schema.bat `SQLSERVERNAME` "

        ![AppV46SQLcreatebat](images/appv46sqlcreatebat.bmp)

    -   Если при создании новой базы данных "APPVIRTDB" происходит сбой сценария, проверьте журнал так, как указано, для устранения этой ошибки. Чтобы убедиться, что последующие попытки будут работать правильно, необходимо удалить базу данных, созданную с частичным запуском сценариев.

2.  Запустите `create_tables.bat` файл, чтобы создать таблицы в базе данных. Выполнение сценария займет несколько секунд, и его не следует прерывать.

    -   Запустите файл create\_tables.bat из каталога, в который он был скопирован. Синтаксис: "create\_tables.bat `SQLSERVERNAME DBNAME` "

        ![create\-table.bat SQL App-v 4,6](images/appv46sqlcreate-tablebat.gif)

        Если при создании таблиц происходит сбой сценария, проверьте журнал так, как указано, для устранения этой ошибки. Перед запуском create\_tables.bat файла на всех последующих попытках потребуется удалить базу данных и выполнить create\_schema.bat.

### Настройка разрешений для базы данных App-V

Следующие учетные записи должны быть созданы на сервере SQL Server с определенными разрешениями и ролями в новой базе данных для установки, развертывания и текущего администрирования среды App-V.

-   Создайте учетную запись для группы администраторов App-V на сервере SQL Server и в базе данных APPVIRTDB для "Администраторы domain\\App-V" (где "Domain" и "Administrators Administrators") будет изменена в соответствии с вашей средой и добавить их в роль "SFTAdmin" и "SFTEveryone".

    ![сценарий SQL App-v 4,6 Настройка разрешений и ролей](images/appv46sqlscriptsetpermsroles.gif)

-   Предоставьте этой группе разрешение VIEW ANY DEFINITION на глобальном уровне (это позволяет настроить сервер управления виртуализацией приложений (Майкрософт) для проверки того, что имя пользователя для входа на него уже существует). В разделе MS-SQL 2005 и более поздних ограничений на доступ к метаданным, содержащимся в Master. DB, были добавлены. Пользователь, созданный на предыдущем этапе, по умолчанию не имеет прав, необходимых для установки сервера. Откройте свойства для ранее созданного имени для входа — &gt; защищаемые объекты. Добавьте экземпляр базы данных и включите "GRANT" для представления Any View definition, как показано на снимке экрана ниже.

    ![сценарий SQL App-v 4,6 Grant разрешение VIEW ANY DEF](images/appv46sqlscriptviewanydef.gif)

-   Добавьте роль в таблицу ROLE \ _ASSIGNMENTS для имени для входа, созданного на предыдущем шаге, чтобы предоставить администраторам App-V доступ к консоли управления виртуализации приложений, с ролью = "Администратор" и группой \ _ref = "domain\\App-V Administrators" (где "Domain" и "App-V Administrators") будет изменена в соответствии с вашей средой.

    ![назначение роли сценария SQL App-v 4,6](images/appv46sqlscriptroleassign.gif)

-   Создание имени входа для SQL Server и базы данных App-V для сервера управления. Эта учетная запись используется сервером управления виртуализацией приложений Майкрософт для подключения к хранилищу данных и ответственен за обслуживание запросов клиентов для потоковых приложений. В зависимости от того, где нужно установить SQL Server и сервер управления, существует два варианта:

    1.  Если сервер управления и SQL Server будут установлены на одном компьютере, добавьте имя входа для службы NT AUTHORITY\\NETWORK и добавьте его в роли базы данных SFTUser и SFTEveryone.

    2.  Если сервер управления и SQL Server должны быть установлены на разных компьютерах, добавьте имя для входа в учетную запись "domain\\App-V Server Name $" (где "App-V Server Name") — это имя сервера, на котором будет установлено сервер управления App-V, и добавьте его в роли базы данных SFTUser и SFTEveryone.

-   Откройте окно запроса в окне SQL и выполните следующую команду SQL:

    ``` syntax
    USE APPVIRTDB
    GRANT ALTER ON ROLE::SFTuser TO “domain\App-V Admins”
    ```

    Где APPVIRTDB — это имя базы данных App-V, созданной на сервере SQL Server на предыдущем этапе, и пользователь, который намеревается установить сервер App-v, должен быть членом группы "Администраторы domain\\App-V" (где "Domain" и "Администраторы App-V") будут изменены в соответствии с вашей средой.

### Задачи, которые должны выполняться администраторами инфраструктуры

1.  Администратор в группе "Администраторы App-V" должен установить App-V.

    Используйте сведения из администраторов SQL для выбора SQL Server и базы данных, созданной в предыдущих шагах.

2.  Администратор в группе "Администраторы App-V" входит в консоль управления виртуализацией приложений и удаляет следующие объекты из консоли управления.

    **Warning**  
    Это необходимо, так как при использовании обычной настройки некоторые записи в базе данных будут заполнены, которые не заполнены при запуске установки для уже существующей базы данных. Удалите следующие объекты:

    -   В разделе "группы серверов", "Группа серверов по умолчанию", "Удалить" сервер управления виртуализацией приложений "

    -   В разделе "группы серверов" Удалить "Группа сервера по умолчанию"

    -   В разделе "политики поставщика" удалите "поставщик по умолчанию"



3.  Администратор в группе "Администраторы" App-V должен создать:

    -   В разделе "политики поставщика" Создайте новую политику поставщика.

    -   Создание группы серверов по умолчанию

        **Примечание.**  
        Вы должны создать группу "сервер по умолчанию", даже если вы не будете использовать ее. Установщик сервера ищет только "Группа серверов по умолчанию" при попытке добавить сервер.  Если "Группа сервера по умолчанию" отсутствует, установка завершается сбоем. Если вы планируете использовать серверные группы, отличные от используемых по умолчанию, необходимо сохранить "группу сервера по умолчанию", если вы планируете добавить последующие серверы управления App-V в инфраструктуру.



~~~
-   Assign the App-V Users Group to the New Provider Policy created above

-   Under “Server Groups,” create a New Server Group, specifying the New Provider Policy

-   Under the New Server group, create a New Application Virtualization Management Server

    **Important**  
    Do not restart the service before completing all of the above steps!



-   Administrator restarts the Application Virtualization Management Server service.
~~~

## Заключение


В заключение информация в этом документе позволяет администратору работать с администраторами SQL для разработки пути развертывания, который подходит для обеспечения безопасности и администрирования разделов в Организации. После прочтения документа и проверки описанных здесь задач администратор должен подготовиться к реализации инфраструктуры App-V в среде этого типа.









